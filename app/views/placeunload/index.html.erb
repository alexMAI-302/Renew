<html>
<head>
<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/1.1/index.xml?key=ADh8UkwBAAAA-f5qPAIAXlBgstzuwer3VtCIdJ9TLbfB6WoAAAAAAAAAAADcdhGtjFd6a6RPHi8luz3UxLa8JA==" type="text/javascript">
	</script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var map;
		var pp = <%= @rst_new %> ; 
		var placemarks = new Array;
		var current_id = 0;
		var isadr = 0;
		var main_city = [{"city": "Москва"}];
		var rr = <%= @route_json %> ;
		var polygons = new Array; 
		var style1;

        window.onload  = function () {
            map = new YMaps.Map(document.getElementById("YMapsID"));
            map.setCenter(new YMaps.GeoPoint(<%= @longitude %> , <%= @latitude %>), 13);
      
  	        map.addControl(new YMaps.TypeControl());
            map.addControl(new YMaps.Zoom());
            
			for (var i = 0; i < pp.length; i++) {
				placemarks[i] = new YMaps.Placemark(new YMaps.GeoPoint(pp[i].longitude, pp[i].latitude), 
				{style: "default#shopIcon", draggable: false,
				balloonOptions: {
						maxWidth: 100,
						mapAutoPan: 0
				}
				});
				placemarks[i].description = pp[i].pname;
				placemarks[i].row_id      = pp[i].id;
				map.addOverlay(placemarks[i]);
				YMaps.Events.observe(placemarks[i], placemarks[i].Events.DragEnd, function (obj) {
					$('a_' + current_id + '_longitude').value = Math.round(obj.getGeoPoint().getLng()*1000000)/1000000;
					$('a_' + current_id + '_latitude').value  = Math.round(obj.getGeoPoint().getLat()*1000000)/1000000;
					on_needsave(current_id);
					for (var i = 0; i < rr.length; i++) {
						if ( polygons[i].contains(obj.getGeoPoint()) ) {
							$('a_' + current_id + '_buyers_route_id').value = rr[i].id;
						};
					};		
				});
				YMaps.Events.observe(placemarks[i], placemarks[i].Events.BalloonOpen, function (obj) {
					$$('tr.rdata').each(function(d){
						d.style.backgroundColor = 'white';
					});
					$('row_' + obj.row_id ).style.backgroundColor = '#FFFBB2';
					$('row_' + obj.row_id ).scrollIntoView();
					pred_id = current_id; 
					current_id = obj.row_id;
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == current_id) {
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
						}
						else {
							if (pp[i].id == pred_id) { 
								placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
							};
						};
					};
				});
            };
            YMaps.Events.observe(map, map.Events.Click, function (map, mEvent) {
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == current_id) {
						placemarks[i].setGeoPoint(mEvent.getGeoPoint());
					};
				};
				$('a_' + current_id + '_longitude').value = Math.round(mEvent.getGeoPoint().getLng()*1000000)/1000000;
			    $('a_' + current_id + '_latitude').value  = Math.round(mEvent.getGeoPoint().getLat()*1000000)/1000000;
				on_needsave(current_id);
				for (var i = 0; i < rr.length; i++) {
					if ( polygons[i].contains(mEvent.getGeoPoint()) ) {
						$('a_' + current_id + '_buyers_route_id').value = rr[i].id;
					};
				};					
            });
			
			style1 = new YMaps.Style("default#greenPoint");
			style1.polygonStyle = new YMaps.PolygonStyle();
			style1.polygonStyle.fillColor = "ffff0011";
			style1.hasBalloon = false;
			YMaps.Styles.add("polygon#Example1", style1);
			for (var i = 0; i < rr.length; i++) {
				polygons[i] = YMaps.Polygon.fromEncodedPoints( rr[i].points, "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", {style: "polygon#Example1"});
				polygons[i].name = rr[i].name;
				map.addOverlay(polygons[i]);
				YMaps.Events.observe(polygons[i], polygons[i].Events.Click, function (polygon, mEvent) {
					YMaps.Events.notify(map, map.Events.Click, map, mEvent);
				});
				for (var j = 0; j < pp.length; j++) {
					if ( polygons[i].contains(placemarks[j].getGeoPoint()) ) {
						if ($('a_' + pp[j].id + '_buyers_route_id').value != rr[i].id) {
							$('a_' + pp[j].id + '_buyers_route_id').value = rr[i].id;
							//$('a_' + pp[j].id + '_needsave').checked = true;
						};
					};
				};			
            };		


        };
			function find_addr(sid){ 
			var srcaddress = $('a_' + sid + '_srcaddress').value;
			var geocoder = new YMaps.Geocoder(srcaddress);
			
			on_select( sid );
			
			// Создание обработчика для успешного завершения геокодирования
            YMaps.Events.observe(geocoder, geocoder.Events.Load, function () {
				var n = this.length();
				var geoResult;
				if (n>0) {
						geoResult = this.get(0);
				}else {
					alert("Ничего не найдено!");
					return;
				};
				
				if (geoResult.kind == "country" || geoResult.kind == "province" || geoResult.kind == "district") {
					alert("Слишком общий адрес!");
					return;
				};
				if (geoResult.kind == 'locality') {
					for (var i = 0; i < main_city.length; i++) { 
						try {
							if (geoResult.AddressDetails.Country.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в городе!");
								return;
							};
						}
						catch(e) {
								;
						};
						try {
							if (geoResult.AddressDetails.Country.AdministrativeArea.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в области!");
								return;
							};
						}
						catch(e) {
								;
						};
					};
				};
				map.setCenter(geoResult.getGeoPoint(), 16);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
						placemarks[i].setGeoPoint(geoResult.getGeoPoint());
						placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
						$('a_' + sid + '_fulladdress').value = geoResult.text;
						$('a_' + sid + '_needsave').checked = true;
						for (var j = 0; j < rr.length; j++) {
							if ( polygons[j].contains(placemarks[i].getGeoPoint() ) ) {
								$('a_' + sid + '_buyers_route_id').value = rr[j].id;
							};
						};
					}
					else {
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};
				$('a_' + current_id + '_longitude').value = Math.round(geoResult.getGeoPoint().getLng()*1000000)/1000000;
				$('a_' + current_id + '_latitude').value  = Math.round(geoResult.getGeoPoint().getLat()*1000000)/1000000;
				
            });

            // Процесс геокодирования завершен неудачно
            YMaps.Events.observe(geocoder, geocoder.Events.Fault, function (geocoder, error) {
                alert("Произошла ошибка: " + error);
            })
			
		};
		function on_needsave( sid ){
			$('a_' + sid + '_needsave').checked = true;
		};
		
		function submitIt(event, sid) {
			$('a_' + sid + '_needsave').checked = true;
			if ((event.keyCode == 0xA) || (event.keyCode == 0xD)) {
				isadr = 1;
				find_addr(sid);
			};
		};
		function on_select( sid ){
			var pred_id=0;
			var longitude = parseFloat($('a_' + sid + '_longitude').value);
			var latitude = parseFloat($('a_' + sid + '_latitude').value);
			
			if ( !isNaN(longitude) && !isNaN(latitude) ) {
				map.setCenter(new YMaps.GeoPoint( longitude, latitude), 16);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
					}
					else {
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};	
			};
			$$('tr.rdata').each(function(d){
				d.style.backgroundColor = 'white';
			});
			$('row_' + sid ).style.backgroundColor = '#FFFBB2';
			pred_id = current_id; 
			current_id = sid;
			for (var i = 0; i < pp.length; i++) {
				if (pp[i].id == current_id) {
					placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
				}
				else {
					if (pp[i].id == pred_id) { 
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};
			};
		};

	</script>
<%	end -%>
</head>
<body>
<% content_for :title do %>
Координаты торговых точек
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					<nobr>
						<label for="pname">Вывеска:</label>
						<%= text_field(:flt, :name, :value => @flt_name, :size=> 15, :maxlength => 255 ) %>
						<label for="paddress">Адрес:</label>
						<%= text_field(:flt, :address, :value => @flt_address, :size=> 25, :maxlength => 255 ) %>
						<label for="pischeck">Проверен:</label>
						<%= select(:flt, :ischeck, [["Все",-1],["Да",1],["Нет",0]], :selected => @flt_ischeck ) %>
						<label for="tp">ТП:</label>
						<%= text_field(:flt, :tp, :value => @flt_tp, :size=> 15, :maxlength => 255 ) %>
						<label for="br_id">Маршрут:</label>
						<%=  select(:flt, :buyers_route_id, [["Все",0]]+@buyers_route_list, {:selected => @flt_buyers_route_id})%>
						<label for="br_id">Древность:</label>
						<%= text_field(:flt, :ddate, :value => @flt_ddate, :size=> 3, :maxlength => 3 ) %>
						<label for="br_id">Не геокодированы:</label>
						<%= check_box(:flt, :notgeo, :style=>"border : none", :value => @flt_notgeo, :checked => (@flt_notgeo==1) ) %>
						<%= submit_tag 'Выбрать' %>
					</nobr>		
				</fieldset>
			<% end %> 
		</div>
		
		<div
			id="map"
			style="width: 30%;
			float: right;">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 68%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="20%" class="th1">Вывеска <br/> Примеч.</td>
						<td width="35%">Адрес <br/> Геокодированный адрес</td>
						<td width="8%">Шир. <br/> Долг.</td>
						<td width="10%">Кат. <br/> Вр. разгр.</td>
						<td width="10%">Вр.дост. <br/> Вр.инк.</td>
						<td width="10%">Маршр. <br/> Провер.</td>
						<td width="4%">Сохр</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_point'}, {:onsubmit => "if (isadr == 1 ) {isadr=0;return false;}"} ) do %>	
			<div id="buyers" style="width: 68%">	
				<div id="mainform">
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr
								<%= "id=\"row_#{a["id"]}\"" %> class="rdata" onclick="on_select(<%= a["id"] %>)" >
								<td width="20%" id="small_name" ><%= text_field(:a, :pname, :index => a["id"] , :value => a["pname"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
												<br/>
									<%= text_field(:a, :descr, :index => a["id"] , :value => a["descr"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>			
								</td>
								<td width="35%"><%= text_field(:a, :srcaddress, :index => a["id"] , :value => a["srcaddress"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeypress => "submitIt(event, #{a["id"]});" ) %>
												<br/>
											   <%= text_field(:a, :fulladdress, :index => a["id"] , :value => a["fulladdress"], :maxlength => 255, :class => "boxintable gray", :style=>"background-color : transparent", :readonly => 'true') %>
												<br/>
											   <%= text_field(:a, :tp, :index => a["id"] , :value => a["tp"], :maxlength => 255, :class => "boxintable gray", :style=>"background-color : transparent", :readonly => 'true') %>											   
								</td>
								<td width="8%"><%= text_field(:a, :latitude, :index => a["id"] , :value => a["latitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
												<br/>
												<%= text_field(:a, :longitude, :index => a["id"] , :value => a["longitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
												<br/>
												<select id="a_<%= a["id"] %>_join" name="a[<%= a["id"] %>][join]" style="width : 90%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
													<%= options_for_select [['_',-1],['Осн.',1],['Доб.',2]], -1 %>
												</select>
								</td>
								<td width="10%"><select id="a_<%= a["id"] %>_placecategory_id" name="a[<%= a["id"] %>][placecategory_id]" style="width : 100%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
												<%= options_for_select @placecategory_list, a["placecategory_id"] %>
												</select>
												<br/>
												<select id="a_<%= a["id"] %>_unloading" name="a[<%= a["id"] %>][unloading]" style="width : 100%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
												<%= options_for_select @unloading_list, a["unloading"] %>
												</select>
								</td>		
								<td width="10%"><select id="a_<%= a["id"] %>_delscheduleid" name="a[<%= a["id"] %>][delscheduleid]" style="width : 100%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
												<%= options_for_select @schedule_list, a["delscheduleid"] %>
												</select>
												<br/>
												<select id="a_<%= a["id"] %>_incscheduleid" name="a[<%= a["id"] %>][incscheduleid]" style="width : 100%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
												<%= options_for_select @schedule_list, a["incscheduleid"] %>
												</select>
								</td>
								<td width="10%">
									<select id="a_<%= a["id"] %>_buyers_route_id" name="a[<%= a["id"] %>][buyers_route_id]" style="width : 100%; background-color : transparent" onChange="on_needsave(<%= a["id"] %>)" >
												<%= options_for_select @buyers_route_list, a["buyers_route_id"] %>
									</select>
									<br/>
									<%= check_box(:a, :ischeck, :index => a["id"], :style=>"border : none", :value => a["ischeck"], :checked => (a["ischeck"]==1), :onclick => "on_needsave(#{a["id"]})" ) %>
								</td>
								<td width="4%">
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"border : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>			
						
				</div>
			</div>
			<div id="operblock">		
				<%= submit_tag "Сохранить" %>
			</div>
		<% end %>
		
	</div>
<% end -%>
<% render :file => 'layouts/application' %>
</body>
</html>