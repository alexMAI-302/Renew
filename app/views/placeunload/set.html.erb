<html>
<head>
<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/1.1/index.xml?key=ADh8UkwBAAAA-f5qPAIAXlBgstzuwer3VtCIdJ9TLbfB6WoAAAAAAAAAAADcdhGtjFd6a6RPHi8luz3UxLa8JA==" type="text/javascript">
	</script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var map;
		var pp = [] ; 
		var placemarks = new Array;
		var current_id = 0;
		var isadr = 0;
		var main_city = [{"city": "Москва"}];
        window.onload  = function () {
            map = new YMaps.Map(document.getElementById("YMapsID"));
            map.setCenter(new YMaps.GeoPoint(<%= @longitude %> , <%= @latitude %>), 13);
      
  	        map.addControl(new YMaps.TypeControl());
            map.addControl(new YMaps.Zoom());
            
			for (var i = 0; i < pp.length; i++) {
				placemarks[i] = new YMaps.Placemark(new YMaps.GeoPoint(pp[i].longitude, pp[i].latitude), 
				{style: "default#shopIcon", draggable: false,
				balloonOptions: {
						maxWidth: 100,
						mapAutoPan: 0
				}
				});
				placemarks[i].description = pp[i].pname;
				map.addOverlay(placemarks[i]);
				YMaps.Events.observe(placemarks[i], placemarks[i].Events.DragEnd, function (obj) {
					$('a_' + current_id + '_longitude').value = Math.round(obj.getGeoPoint().getLng()*1000000)/1000000;
					$('a_' + current_id + '_latitude').value  = Math.round(obj.getGeoPoint().getLat()*1000000)/1000000;
					$('a_' + current_id + '_ismanual').checked = true;
					on_needsave(current_id);
				});
            };
            YMaps.Events.observe(map, map.Events.Click, function (map, mEvent) {
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == current_id) {
						placemarks[i].setGeoPoint(mEvent.getGeoPoint());
					};
				};
				$('a_' + current_id + '_longitude').value = Math.round(mEvent.getGeoPoint().getLng()*1000000)/1000000;
			    $('a_' + current_id + '_latitude').value  = Math.round(mEvent.getGeoPoint().getLat()*1000000)/1000000;
				$('a_' + current_id + '_ismanual').checked = true;
				on_needsave(current_id);
            });

        };
			function find_addr(sid){ 
			var srcaddress = $('a_' + sid + '_srcaddress').value;
			var geocoder = new YMaps.Geocoder(srcaddress);
			
			on_select( sid );
			
			// Создание обработчика для успешного завершения геокодирования
            YMaps.Events.observe(geocoder, geocoder.Events.Load, function () {
				var n = this.length();
				var geoResult;
				if (n>0) {
						geoResult = this.get(0);
				}else {
					alert("Ничего не найдено!");
					return;
				};
				
				if (geoResult.kind == "country" || geoResult.kind == "province" || geoResult.kind == "district") {
					alert("Слишком общий адрес!");
					return;
				};
				if (geoResult.kind == 'locality') {
					for (var i = 0; i < main_city.length; i++) { 
						try {
							if (geoResult.AddressDetails.Country.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в городе!");
								return;
							};
						}
						catch(e) {
								;
						};
						try {
							if (geoResult.AddressDetails.Country.AdministrativeArea.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в области!");
								return;
							};
						}
						catch(e) {
								;
						};
					};
				};
				map.setCenter(geoResult.getGeoPoint(), 13);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
							placemarks[i].setGeoPoint(geoResult.getGeoPoint());
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
							placemarks[i].openBalloon();
							$('a_' + sid + '_fulladdress').value = geoResult.text;
							$('a_' + sid + '_needsave').checked = true;
					}
					else {
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};
				$('a_' + current_id + '_longitude').value = Math.round(geoResult.getGeoPoint().getLng()*1000000)/1000000;
				$('a_' + current_id + '_latitude').value  = Math.round(geoResult.getGeoPoint().getLat()*1000000)/1000000;
            });

            // Процесс геокодирования завершен неудачно
            YMaps.Events.observe(geocoder, geocoder.Events.Fault, function (geocoder, error) {
                alert("Произошла ошибка: " + error);
            })
			
		};
		function on_needsave( sid ){
			$('a_' + sid + '_needsave').checked = true;
		};
		
		function submitIt(event, sid) {
			$('a_' + sid + '_needsave').checked = true;
			if ((event.keyCode == 0xA) || (event.keyCode == 0xD)) {
				isadr = 1;
				find_addr(sid);
			};
		};
		function on_select( sid ){
			var pred_id=0;
			var longitude = parseFloat($('a_' + sid + '_longitude').value);
			var latitude = parseFloat($('a_' + sid + '_latitude').value);
			
			if ( !isNaN(longitude) && !isNaN(latitude) ) {
				map.setCenter(new YMaps.GeoPoint( longitude, latitude), 13);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
							placemarks[i].openBalloon();
					}
					else {
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};	
			};
			$$('tr.rdata').each(function(d){
				d.style.backgroundColor = 'white'; 
			});
			$('row_' + sid ).style.backgroundColor = '#FFFBB2';
			pred_id = current_id; 
			current_id = sid;
			for (var i = 0; i < pp.length; i++) {
				if (pp[i].id == current_id) {
					placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
				}
				else {
					if (pp[i].id == pred_id) { 
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};
			};
		};

	</script>
<%	end -%>
</head>
<body>
<% content_for :title do %>
Укажите адрес разгрузки
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
			<div id="groupselect">
				<% form_tag( {:action => 'save_point'}, {:onsubmit => "if (isadr == 1 ) {isadr=0;return false;}"} ) do %>	
				Выберите подходящий адрес для покупателя <%= @buyer["name"] %> 
				<%= text_field(:a, :loadto, :value => @buyer["loadto"], :size => 75, :maxlength => 255, :style=>"background-color : transparent") %>												
				<br/>
				Если точка на карте расположена неправильно, то измените адрес или подвинте точку 
				<div id="operblock">		
					<%= submit_tag "Сохранить" %>
				</div>
				<% end %>
		</div>
		
		<div
			id="map"
			style="width: 60%;
			float: right;">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 38%;
			float: left;">
		
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="20%" class="th1">Имя</td>
						<td width="80%">Адрес <br>Геокодированный адрес</td>
				   </tr>
				</table>
			</div>
		</div>
		<div id="buyers">	
			<div id="mainform">					
					<table width="100%" border="0" cellpadding="2" cellspacing="1">
						<tr>
							<td width="20%" id="small_name" >xxx</td>
							<td width="80%">xxx</td>			
						</tr>
						<tr>
							<td width="20%" id="small_name" >xxx</td>
							<td width="80%">xxx</td>			
						</tr>
						<tr>
							<td width="20%" id="small_name" ></td>
							<td width="80%">Это новая точка</td>	
						</tr>
					</table>			
			</div>
		</div>
	</div>
<% end -%>
<% render :file => 'layouts/application' %>
</body>
</html>