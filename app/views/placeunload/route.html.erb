
<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/2.0/?load=package.full&mode=debug&lang=ru-RU" type="text/javascript"></script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		ymaps.ready(function(){
			var map,
				pp = <%= @rst_new %>,
				rr = <%= @route_json %>,
				style1 = 
				{
					// - цвет и прозрачность линии
					strokeColor: "ffff0088",
					// - цвет и прозрачность заливки
					fillColor: "ff000055"
				};
			// Создание экземпляра карты и его привязка к созданному контейнеру
			map = new ymaps.Map("YMapsID", {
				// Центр карты
				center : center,
				zoom : 10,
				// Тип карты
				type : "yandex#map",
				behaviors : ["default", "scrollZoom"]
			});

			// Добавление элементов управления
			map.controls.add("zoomControl");
			map.controls.add("typeSelector");
			map.controls.add("mapTools");
			
			for(var i = 0; i < rr.length; i++) {
				var polygon = new ymaps.Polygon(
					ymaps.geometry.Polygon.fromEncodedCoordinates(rr[i].points),
					null,
					style1);
				map.geoObjects.add(polygons);
				for(var j = 0; j < pp.length; j++) {
					if(polygon.geometry.contains(pp[j].latitude, pp[j].longitude)) {
						if($('a_' + pp[j].id + '_buyers_route_id').value != rr[i].id) {
							$('a_' + pp[j].id + '_buyers_route_id').value = rr[i].id;
							$('a_' + pp[j].id + '_needsave').checked = true;
						};
					};
				};
			};
			$('spinner1').hide();
		});
	</script>
<%	end -%>
<% content_for :title do %>
Привязка к зонам
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					
				</fieldset>
			<% end %> 
		</div>
		
		<div
			id="map"
			style="width: 30%;
			float: right;">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 68%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="80%" class="th1">Вывеска </td>
						<td width="10%">Маршр. </td>
						<td width="10%">Сохр</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_route'} ) do %>	
			<div id="buyers" style="width: 68%">	
				<div id="mainform">
						<%= image_tag('ajax-loader.gif', :id => 'spinner1') %>
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr class="rdata">
								<td width="80%" id="small_name" ><%=  a["pname"] %>
								</td>
								<td width="10%">
									<%= text_field(:a, :buyers_route_id, :index => a["id"], :value =>  a["buyers_route_id"], :maxlength => 255 ) %>
								</td>
								<td width="10%">
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"border : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>	
				</div>
			</div>
			<div id="operblock">		
				<%= submit_tag "Сохранить" %>
			</div>
		<% end %>
		
	</div>
<% end -%>
<% render :file => 'layouts/application' %>