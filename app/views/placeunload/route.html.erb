<html>
<head>
<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/1.1/index.xml?key=ADh8UkwBAAAA-f5qPAIAXlBgstzuwer3VtCIdJ9TLbfB6WoAAAAAAAAAAADcdhGtjFd6a6RPHi8luz3UxLa8JA==" type="text/javascript">
	</script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var map;
		var pp = <%= @rst_new %> ; 
		
		var current_id = 0;
		
		var rr = <%= @route_json %> ;
		var polygons = new Array; 
		var style1;
		var gp;
		
        window.onload  = function () {
            map = new YMaps.Map(document.getElementById("YMapsID"));
            map.setCenter(new YMaps.GeoPoint(<%= @longitude %> , <%= @latitude %>), 9);
      
  	        map.addControl(new YMaps.TypeControl());
            map.addControl(new YMaps.Zoom());
            
						
			style1 = new YMaps.Style("default#greenPoint");
			style1.polygonStyle = new YMaps.PolygonStyle();
			style1.polygonStyle.fillColor = "ffff0011";
			style1.hasBalloon = false;
			YMaps.Styles.add("polygon#Example1", style1);
			for (var i = 0; i < rr.length; i++) {
				polygons[i] = YMaps.Polygon.fromEncodedPoints( rr[i].points, "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", {style: "polygon#Example1"});
				map.addOverlay(polygons[i]);
				for (var j = 0; j < pp.length; j++) {
					if ( polygons[i].contains( new YMaps.GeoPoint(pp[j].longitude, pp[j].latitude) ) ) {
						if ($('a_' + pp[j].id + '_buyers_route_id').value != rr[i].id) {
							$('a_' + pp[j].id + '_buyers_route_id').value = rr[i].id;
							$('a_' + pp[j].id + '_needsave').checked = true;
						};
					};
				};			
            };
			$('spinner1').hide();
        };
	</script>
<%	end -%>
</head>
<body>
<% content_for :title do %>
Привязка к зонам
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					
				</fieldset>
			<% end %> 
		</div>
		
		<div
			id="map"
			style="width: 30%;
			float: right;">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 68%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="80%" class="th1">Вывеска </td>
						<td width="10%">Маршр. </td>
						<td width="10%">Сохр</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_route'} ) do %>	
			<div id="buyers" style="width: 68%">	
				<div id="mainform">
						<%= image_tag('ajax-loader.gif', :id => 'spinner1') %>
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr class="rdata">
								<td width="80%" id="small_name" ><%=  a["pname"] %>
								</td>
								<td width="10%">
									<%= text_field(:a, :buyers_route_id, :index => a["id"], :value =>  a["buyers_route_id"], :maxlength => 255 ) %>
								</td>
								<td width="10%">
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"border : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>	
				</div>
			</div>
			<div id="operblock">		
				<%= submit_tag "Сохранить" %>
			</div>
		<% end %>
		
	</div>
<% end -%>
<% render :file => 'layouts/application' %>
</body>
</html>