<html>
<head>
<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/1.1/index.xml?key=ADh8UkwBAAAA-f5qPAIAXlBgstzuwer3VtCIdJ9TLbfB6WoAAAAAAAAAAADcdhGtjFd6a6RPHi8luz3UxLa8JA==" type="text/javascript">
	</script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var map;
		var pp = <%= @rst_new %> ; 
		var placemarks = new Array;
		var placemark;
		var current_id = 0;
		var isadr = 0;
		var main_city = [{"city": "Москва"}];

        window.onload  = function () {
            map = new YMaps.Map(document.getElementById("YMapsID"));
            map.setCenter(new YMaps.GeoPoint(<%= @longitude %> , <%= @latitude %>), 13);
      
  	        map.addControl(new YMaps.TypeControl());
            map.addControl(new YMaps.Zoom());
            
			for (var i = 0; i < pp.length; i++) {
				placemarks[i] = new YMaps.Placemark(new YMaps.GeoPoint(pp[i].longitude, pp[i].latitude), 
				{style: "default#shopIcon", draggable: false,
				balloonOptions: {
						maxWidth: 100,
						mapAutoPan: 0
				}
				});
				placemarks[i].description = pp[i].pname;
				placemarks[i].row_id      = pp[i].id;
				map.addOverlay(placemarks[i]);
				YMaps.Events.observe(placemarks[i], placemarks[i].Events.DragEnd, function (obj) {
					$('a_' + current_id + '_longitude').value = Math.round(obj.getGeoPoint().getLng()*1000000)/1000000;
					$('a_' + current_id + '_latitude').value  = Math.round(obj.getGeoPoint().getLat()*1000000)/1000000;
  				    $('a_' + current_id + '_fulladdress').value = $('a_' + current_id + '_longitude').value + ' ' + $('a_' + current_id + '_latitude').value;
					on_needsave(current_id);		
				});
				YMaps.Events.observe(placemarks[i], placemarks[i].Events.BalloonOpen, function (obj) {
					$('topform').select('tr.rdata').each(function(d){
						d.style.backgroundColor = 'white';
					});
					$('row_' + obj.row_id ).style.backgroundColor = '#FFFBB2';
					$('row_' + obj.row_id ).scrollIntoView();
					pred_id = current_id; 
					current_id = obj.row_id;
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == current_id) {
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
						}
						else {
							if (pp[i].id == pred_id) { 
								placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
							};
						};
					};
				});
            };
            YMaps.Events.observe(map, map.Events.Click, function (map, mEvent) {
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == current_id) {
						placemarks[i].setGeoPoint(mEvent.getGeoPoint());
					};
				};
				$('a_' + current_id + '_longitude').value   = Math.round(mEvent.getGeoPoint().getLng()*1000000)/1000000;
			    $('a_' + current_id + '_latitude').value    = Math.round(mEvent.getGeoPoint().getLat()*1000000)/1000000;
				$('a_' + current_id + '_fulladdress').value = $('a_' + current_id + '_longitude').value + ' ' + $('a_' + current_id + '_latitude').value;
				on_needsave(current_id);
            });
        };
		
		function geocode_addr(srcaddress, iscoord) {
			var geocoder = new YMaps.Geocoder(srcaddress);
			$('spinner1').show();
			$('subform').update('Подождите пожалуйста, идет поиск.....');			
			YMaps.Events.observe(geocoder, geocoder.Events.Load, function () {
				var n = this.length();
				var geoResult;
				if (n>0) {
					geoResult = this.get(0);
				}
				else {
					alert("Ничего не найдено!");
					$('spinner1').hide(); 
					$('subform').update('Ошибка!');
					return;
				};
					
				if (geoResult.kind == "country" || geoResult.kind == "province" || geoResult.kind == "district") {
					alert("Слишком общий адрес!");
					$('spinner1').hide(); 
					$('subform').update('Ошибка!');
					return;
				};
				if (geoResult.kind == 'locality') {
					for (var i = 0; i < main_city.length; i++) { 
						try {
							if (geoResult.AddressDetails.Country.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в городе!");
								$('spinner1').hide(); 
								$('subform').update('Ошибка!');
								return;
							};
						}
						catch(e) {
							;
						};
						try {
							if (geoResult.AddressDetails.Country.AdministrativeArea.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в области!");
								$('spinner1').hide(); 
								$('subform').update('Ошибка!');
								return;
							};
						}
						catch(e) {
							;
						};
					};
				};
				$('a_'+current_id+'_fulladdress').value = geoResult.text;
				if (iscoord) {
					map.setCenter(geoResult.getGeoPoint(), 16);
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == current_id) {
								placemarks[i].setGeoPoint(geoResult.getGeoPoint());
								placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
								$('a_' + current_id + '_fulladdress').value = geoResult.text;
								$('a_' + current_id + '_needsave').checked = true;
						}
						else {
							placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
						};
					};
					$('a_' + current_id + '_longitude').value = Math.round(geoResult.getGeoPoint().getLng()*1000000)/1000000;
					$('a_' + current_id + '_latitude').value  = Math.round(geoResult.getGeoPoint().getLat()*1000000)/1000000;
				};
				<%= remote_function :url =>{ :action => "find_place" }, :with => "'latitude=' + $('a_'+current_id+'_latitude').value + '&longitude=' + $('a_'+current_id+'_longitude').value +'&prov=1'", :update => "subform", :complete => "after_select();" %>
			});
			// Процесс геокодирования завершен неудачно
			YMaps.Events.observe(geocoder, geocoder.Events.Fault, function (geocoder, error) {
				alert("Произошла ошибка: " + error);
				$('spinner1').hide(); 
				$('subform').update('Ошибка!');
			});
		};
		
		function find_addr(sid){ 
			var srcaddress = $('a_' + sid + '_srcaddress').value;
			var geocoder = new YMaps.Geocoder(srcaddress);
			
			// Создание обработчика для успешного завершения геокодирования
            YMaps.Events.observe(geocoder, geocoder.Events.Load, function () {
				var n = this.length();
				var geoResult;
				if (n>0) {
						geoResult = this.get(0);
				}else {
					alert("Ничего не найдено!");
					return;
				};
				
				if (geoResult.kind == "country" || geoResult.kind == "province" || geoResult.kind == "district") {
					alert("Слишком общий адрес!");
					return;
				};
				if (geoResult.kind == 'locality') {
					for (var i = 0; i < main_city.length; i++) { 
						try {
							if (geoResult.AddressDetails.Country.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в городе!");
								return;
							};
						}
						catch(e) {
								;
						};
						try {
							if (geoResult.AddressDetails.Country.AdministrativeArea.Locality.LocalityName == main_city[i].city) {
								alert("Не могу найти улицу в области!");
								return;
							};
						}
						catch(e) {
								;
						};
					};
				};
				map.setCenter(geoResult.getGeoPoint(), 16);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
							placemarks[i].setGeoPoint(geoResult.getGeoPoint());
							placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
							$('a_' + sid + '_fulladdress').value = geoResult.text;
							$('a_' + sid + '_needsave').checked = true;
					}
					else {
						placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
					};
				};
				$('a_' + current_id + '_longitude').value = Math.round(geoResult.getGeoPoint().getLng()*1000000)/1000000;
				$('a_' + current_id + '_latitude').value  = Math.round(geoResult.getGeoPoint().getLat()*1000000)/1000000;
            });

            // Процесс геокодирования завершен неудачно
            YMaps.Events.observe(geocoder, geocoder.Events.Fault, function (geocoder, error) {
                alert("Произошла ошибка: " + error);
            })
			
		};
		function on_needsave( sid ){
			$('a_' + sid + '_needsave').checked = true;
		};
		
		function submitIt(event, sid) {
			$('a_' + sid + '_needsave').checked = true;
			if ((event.keyCode == 0xA) || (event.keyCode == 0xD)) {
				isadr = 1;
				find_addr(sid);
			};
		};
		function on_select( sid ){
			if(sid != current){
				var pred_id=0;
				var longitude = parseFloat($('a_' + sid + '_longitude').value);
				var latitude = parseFloat($('a_' + sid + '_latitude').value);
				
				if ( !isNaN(longitude) && !isNaN(latitude) ) {
					map.setCenter(new YMaps.GeoPoint(longitude, latitude), 16);
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == sid) {
								placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
						}
						else {
							placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
						};
					};	
				};
				$('topform').select('tr.rdata').each(function(d){
					d.style.backgroundColor = 'white'; 
				});
				//очищаем привязку элементов в верхней таблице
				$('topform').select('input.join').each(function(i){
					i.value="-1";
				});
				$('row_' + sid ).style.backgroundColor = '#FFFBB2';
				pred_id = current_id; 
				current_id = sid;
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == current_id) {
						placemarks[i].setOptions({style: "default#workshopIcon", draggable: true});
					}
					else {
						if (pp[i].id == pred_id) { 
							placemarks[i].setOptions({style: "default#shopIcon", draggable: false});
						};
					};
				};
				
				geocode_addr($('a_'+sid+'_fulladdress').value, true);
			}
		};
		
		function on_sub_select( sid ){
			if(sid != current_id){
				$('subform').select('tr.rdata').each(function(d){
					d.style.backgroundColor = 'white';
				});
				//очищаем привязку элементов
				$$('input.join').each(function(i){
					i.value="-1";
				});
				
				$('b_'+sid+'_join').value="1";
				
				$('a_'+current_id+'_join').value="2";
				$('a_'+current_id+'_needsave').checked=true;
				
				$('row_' + sid +'_').style.backgroundColor = 'yellow';
			}
		};
		
		function after_select(){
			$('spinner1').hide();
		};

	</script>
<%	end -%>
</head>
<body>
<% content_for :title do %>
Адреса разгрузки экспедитора
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					<nobr>
						<label for="pischeck">Проверен:</label>
						<%= select(:flt, :ischeck, [["Все",-1],["Да",1],["Нет",0]], :selected => @flt_ischeck ) %>
						<label for="br_id">Маршрут:</label>
						<%=  select(:flt, :buyers_route_id, @buyers_route_list, {:selected => @flt_buyers_route_id})%>
						<%= submit_tag 'Выбрать' %>
					</nobr>		
				</fieldset>
			<% end %> 
		</div>
		
		<div id="map" style="width: 40%;float: right">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 58%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="25%" class="th1">Вывеска <br/> Примеч.</td>
						<td width="70%">Адрес <br/> Геокодированный адрес</td>
						<td width="5%">Провер.</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_point_r'}, {:onsubmit => "if (isadr == 1 ) {isadr=0;return false;}"} ) do %>	
			<div id="buyers" style="width: 58%; height: 380px;">	
				<div id="mainform">
					<div id="topform">
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr
								<%= "id=\"row_#{a["id"]}\"" %> class="rdata" onclick="on_select(<%= a["id"] %>)"
							>
								<td width="25%" id="small_name" ><%= text_field(:a, :pname, :index => a["id"] , :value => a["pname"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
									<br/>
									<%= text_field(:a, :descr, :index => a["id"] , :value => a["descr"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>			
								</td>
								<td width="70%"><%= text_field(:a, :srcaddress, :index => a["id"] , :value => a["srcaddress"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeypress => "submitIt(event, #{a["id"]});" ) %>
									<br/>
									<%= text_field(:a, :fulladdress, :index => a["id"] , :value => a["fulladdress"], :maxlength => 255, :class => "boxintable gray", :style=>"background-color : transparent", :readonly => 'true') %>
									<%= hidden_field(:a, :latitude,  :index => a["id"] , :value => a["latitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
									<%= hidden_field(:a, :longitude, :index => a["id"] , :value => a["longitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]})" ) %>
									<input type="hidden" id="a_<%= a["id"] %>_join" name="a[<%= a["id"] %>][join]" value="-1" class="join"/>
								</td>			
								<td width="5%">
									<%= check_box(:a, :ischeck, :index => a["id"], :style=>"border : none", :value => a["ischeck"], :checked => (a["ischeck"]==1), :onclick => "on_needsave(#{a["id"]})" ) %>
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"display : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>
					</div>
				</div>
			</div>
			<div style="float: left;">
				<%= image_tag('ajax-loader.gif', :id => 'spinner1', :style => 'display:none') %>
				<div id="subform">
					<%= render :partial => "upd_end_prov" %>
				</div>
				<div id="operblock">
					<%= submit_tag "Сохранить" %>
				</div>
			</div>
		<% end %>
		
	</div>
<% end %>
<% render :file => 'layouts/application' %>
</body>
</html>