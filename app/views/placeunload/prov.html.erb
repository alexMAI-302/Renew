<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/2.0/?load=package.full&mode=debug&lang=ru-RU" type="text/javascript"></script>
	<%= javascript_include_tag :defaults %>
	<%= javascript_include_tag "geo" %>
    <script type="text/javascript">
		var map,
			pp = <%= @rst_new %>,
			placemarks = [],
			placemark,
			current_id = 0,
			isadr = 0,
			main_city = [{"city": "Москва"}],
			unact;

        ymaps.ready(function(){
			unact=new Unact();
			
			unact.placeunload.init([<%= @latitude %>, <%= @longitude %>], "prov");
        };
		
		function submitIt(event, sid) {
			$('a_' + sid + '_needsave').checked = true;
			if ((event.keyCode == 0xA) || (event.keyCode == 0xD)) {
				isadr = 1;
				unact.common.find_addr(sid);
			};
		};
		
		function on_sub_select( sid ){
			if(sid != current_id){
				$('subform').select('tr.rdata').each(function(d){
					d.style.backgroundColor = 'white';
				});
				//очищаем привязку элементов
				$$('input.join').each(function(i){
					i.value="-1";
				});
				
				$('b_'+sid+'_join').value="1";
				
				$('a_'+current_id+'_join').value="2";
				$('a_'+current_id+'_needsave').checked=true;
				
				$('row_' + sid +'_').style.backgroundColor = 'yellow';
			}
		};
		
		function after_select(){
			$('spinner1').hide();
		};
		
		function findPlace(){
			<%= remote_function :url =>{ :action => "find_place" }, :with => "'latitude=' + $('a_'+current_id+'_latitude').value + '&longitude=' + $('a_'+current_id+'_longitude').value +'&prov=1&remove='+current_id", :update => "subform", :complete => "after_select();" %>
		};
	</script>
<%	end -%>
<% content_for :title do %>
Адреса разгрузки экспедитора
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					<nobr>
						<label for="pischeck">Проверен:</label>
						<%= select(:flt, :ischeck, [["Все",-1],["Да",1],["Нет",0]], :selected => @flt_ischeck ) %>
						<label for="br_id">Маршрут:</label>
						<%=  select(:flt, :buyers_route_id, @buyers_route_list, {:selected => @flt_buyers_route_id})%>
						<%= submit_tag 'Выбрать' %>
					</nobr>		
				</fieldset>
			<% end %> 
		</div>
		
		<div id="map" style="width: 40%;float: right">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 58%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="25%" class="th1">Вывеска <br/> Примеч.</td>
						<td width="70%">Адрес <br/> Геокодированный адрес</td>
						<td width="5%">Провер.</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_point_r'}, {:onsubmit => "if (isadr == 1 ) {isadr=0;return false;}"} ) do %>	
			<div id="buyers" style="width: 58%; height: 380px;">	
				<div id="mainform">
					<div id="topform">
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr <%= "id=\"row_#{a["id"]}\"" %> class="rdata" onclick="unact.common.on_select(<%= a["id"] %>, true)">
								<td width="25%" id="small_name" ><%= text_field(:a, :pname, :index => a["id"] , :value => a["pname"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "unact.common.on_needsave(#{a["id"]})" ) %>
									<br/>
									<%= text_field(:a, :descr, :index => a["id"] , :value => a["descr"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "unact.common.on_needsave(#{a["id"]})" ) %>			
								</td>
								<td width="70%"><%= text_field(:a, :srcaddress, :index => a["id"] , :value => a["srcaddress"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeypress => "submitIt(event, #{a["id"]});" ) %>
									<br/>
									<%= text_field(:a, :fulladdress, :index => a["id"] , :value => a["fulladdress"], :maxlength => 255, :class => "boxintable gray", :style=>"background-color : transparent", :readonly => 'true') %>
									<%= hidden_field(:a, :latitude,  :index => a["id"] , :value => a["latitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "unact.common.on_needsave(#{a["id"]})" ) %>
									<%= hidden_field(:a, :longitude, :index => a["id"] , :value => a["longitude"], :maxlength => 20, :class => "boxintbl", :style=>"background-color : transparent", :onkeydown => "unact.common.on_needsave(#{a["id"]})" ) %>
									<input type="hidden" id="a_<%= a["id"] %>_join" name="a[<%= a["id"] %>][join]" value="-1" class="join"/>
								</td>			
								<td width="5%">
									<%= check_box(:a, :ischeck, :index => a["id"], :style=>"border : none", :value => a["ischeck"], :checked => (a["ischeck"]==1), :onclick => "unact.common.on_needsave(#{a["id"]})" ) %>
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"display : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>
					</div>
				</div>
			</div>
			<div style="float: left;">
				<%= image_tag('ajax-loader.gif', :id => 'spinner1', :style => 'display:none') %>
				<div id="subform">
					<%= render :partial => "upd_end_prov" %>
				</div>
				<div id="operblock">
					<%= submit_tag "Сохранить" %>
				</div>
			</div>
		<% end %>
		
	</div>
<% end %>
<% render :file => 'layouts/application' %>