<% content_for :title do %>
    Привязка всех точек к зонам доставки
<% end %>

<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/1.1/index.xml?key=ADh8UkwBAAAA-f5qPAIAXlBgstzuwer3VtCIdJ9TLbfB6WoAAAAAAAAAAADcdhGtjFd6a6RPHi8luz3UxLa8JA==" type="text/javascript"></script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var pp = <%= @rst_new %> ;
		var rr = <%= @route_json %> ;
		var polygons = new Array; 
		var style1;
		var map;
		var gp;
        YMaps.jQuery(function () {
            // Создание экземпляра карты и его привязка к созданному контейнеру
            map = new YMaps.Map(YMaps.jQuery("#YMapsID")[0]);
            var placemark;
            // Установка для карты ее центра и масштаба
            map.setCenter(new YMaps.GeoPoint(37.64, 55.76), 8);

            // Добавление элементов управления
            map.enableScrollZoom();
            map.addControl(new YMaps.Zoom());
            map.addControl(new YMaps.TypeControl());
            map.addControl(new YMaps.ToolBar());

			style1 = new YMaps.Style("default#greenPoint");
			style1.polygonStyle = new YMaps.PolygonStyle();
			style1.polygonStyle.fillColor = "ffff0088";
			YMaps.Styles.add("polygon#Example1", style1);
			for (var i = 0; i < rr.length; i++) {
				polygons[i] = YMaps.Polygon.fromEncodedPoints( rr[i].points, "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA", {style: "polygon#Example1"});
				polygons[i].name = rr[i].name;
				map.addOverlay(polygons[i]);
				$('a_' + rr[i].id + '_lroute').value = "";
				for (var j = 0; j < pp.length; j++) {
					if ( rr[i].site == pp[j].site && rr[i].spv_id == pp[j].spv_id) {
						if ( polygons[i].contains(new YMaps.GeoPoint(pp[j].longitude, pp[j].latitude)) ) {
							$('a_' + rr[i].id + '_lroute').value = $('a_' + rr[i].id + '_lroute').value + pp[j].id + ", ";
						};
					};
				};			
            };		
			document.getElementById('theSubmitButton').click();
        });
    </script>
<% end %>

<% content_for :content do %>
	<div id="wrapper">
		<div id="map">	
			<div id="YMapsID"></div>
			<% form_tag :action => 'save_setpt' do %>
				<p><input type="submit" value="Сохранить" id="theSubmitButton"></p>
				<% @rst_route.each do |a| %>			
					<p>
						<%= a["name"] %>
						<%= text_field(:a, :lroute,  :size => "100", :index => a["id"], :value => "", :class => "l-route", :readonly => 'true') %>
					</p>
				<% end %>
			<% end %>
		</div>
	</div>
<% end %>