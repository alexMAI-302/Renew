<% content_for :js do %>
    <script src="http://api-maps.yandex.ru/2.0/?load=package.full&mode=debug&lang=ru-RU" type="text/javascript"></script>
	</script>
	<%= javascript_include_tag :defaults %>
    <script type="text/javascript">
		var map;
		var pp = <%= @rst_new %> ; 
		var placemarks = new Array;
		var current_id = 0;
		var isadr = 0;
		var main_city = [{"city": "Москва"}];
        ymaps.ready(function(){
			map = new ymaps.Map("YMapsID",
				{
					center: [<%= @latitude %>, <%= @longitude %>],
					zoom: 13,
			        behaviors: ["default", "scrollZoom"]
				});
      
  	        // Добавление элементов управления
            map.controls.add("zoomControl");
            map.controls.add("typeSelector");
            
			for (var i = 0; i < pp.length; i++) {
				placemarks[i] = new ymaps.Placemark(
					(pp[i].latitude!=null && pp[i].longitude!=null &&
					pp[i].latitude!="" && pp[i].longitude!="")?
						[pp[i].latitude, pp[i].longitude]:
						[<%= @latitude %>, <%= @longitude %>], 
					{
						draggable: false,
						balloonMaxWidth: 100,
						balloonAutoPan: true,
						balloonContent: pp[i].pname 
					},
					{
						preset: "twirl#shopIcon",
					}
				);
				map.geoObjects.add(placemarks[i]);
				placemarks[i].events.add("dragend", function (mEvent) {
					var coords=mEvent.originalEvent.target.geometry.getCoordinates();
					setCoords(coords);
				});
            };
            map.events.add("click", function (mEvent) {
            	if($('a_' + current_id + '_latitude') != null){
            		var coords=mEvent.get('coordPosition');
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == current_id) {
							placemarks[i].geometry.setCoordinates(coords);
						};
					};
					setCoords(coords);    		
            	}
            });

        });
        
        function setCoords(coords){
        	$('a_' + current_id + '_latitude').value  = Math.round(coords[0]*1000000)/1000000;
			$('a_' + current_id + '_longitude').value = Math.round(coords[1]*1000000)/1000000;
			$('a_' + current_id + '_ismanual').checked = true;
			on_needsave(current_id);
        };
        
		function find_addr(sid){ 
			var srcaddress = $('a_' + sid + '_srcaddress').value;
			var geocoder = new ymaps.geocode(srcaddress);
			
			on_select( sid );
			
			// Создание обработчика для успешного завершения геокодирования
            geocoder.then(
            	function (res) {
					var n = res.geoObjects.getLength();
					var geoResultInfo, geoResultPoint;
					if (n>0) {
							geoResultInfo = res.geoObjects.get(0).properties.get("metaDataProperty").GeocoderMetaData;
							geoResultPoint = res.geoObjects.get(0).geometry.getCoordinates();
					} else {
						alert("Ничего не найдено!");
						return;
					};
					if (geoResultInfo.kind == "country" || geoResultInfo.kind == "province" || geoResultInfo.kind == "district") {
						alert("Слишком общий адрес!");
						return;
					};
					if (geoResultInfo.kind == 'locality') {
						for (var i = 0; i < main_city.length; i++) { 
							try {
								if (geoResultInfo.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.Locality.LocalityName == main_city[i].city) {
									alert("Не могу найти улицу в городе!");
									return;
								};
							}
							catch(e) {
									;
							};
						};
					};
					console.log(geoResultPoint);
					map.setCenter(geoResultPoint, 13, {checkZoomRange: true});
					for (var i = 0; i < pp.length; i++) {
						if (pp[i].id == sid) {
								placemarks[i].options.set("preset", "twirl#workshopIcon");
								placemarks[i].options.set("draggable", true);
								placemarks[i].geometry.setCoordinates(geoResultPoint);
								placemarks[i].balloon.open(geoResultPoint);
								$('a_' + sid + '_fulladdress').value = geoResultInfo.text;
								$('a_' + sid + '_needsave').checked = true;
						}
						else {
							placemarks[i].options.set("preset", "twirl#shopIcon");
							placemarks[i].options.set("draggable", false);
						};
					};
					$('a_' + current_id + '_longitude').value = geoResultPoint[1];
					$('a_' + current_id + '_latitude').value  = geoResultPoint[0];
	            },
	            function (error) {
	            	alert("Произошла ошибка: " + error);
				}
			);
		};
		function on_needsave( sid ){
			$('a_' + sid + '_needsave').checked = true;
		};
		
		function submitIt(event, sid) {
			$('a_' + sid + '_needsave').checked = true;
			if ((event.keyCode == 0xA) || (event.keyCode == 0xD)) {
				isadr = 1;
				find_addr(sid);
			};
		};
		function on_select( sid ){
			var pred_id=0;
			var longitude = parseFloat($('a_' + sid + '_longitude').value);
			var latitude = parseFloat($('a_' + sid + '_latitude').value);
			
			if ( !isNaN(longitude) && !isNaN(latitude) ) {
				map.setCenter([latitude, longitude], 13);
				for (var i = 0; i < pp.length; i++) {
					if (pp[i].id == sid) {
							placemarks[i].options.set("preset", "twirl#workshopIcon");
							placemarks[i].options.set("draggable", true);
							placemarks[i].balloon.open([latitude, longitude]);
					}
					else {
						placemarks[i].options.set("preset", "twirl#shopIcon");
						placemarks[i].options.set("draggable", false);
					};
				};	
			};
			$$('tr.rdata').each(function(d){
				d.style.backgroundColor = 'white'; // был transparent
			});
			$('row_' + sid ).style.backgroundColor = '#FFFBB2';
			pred_id = current_id; 
			current_id = sid;
			for (var i = 0; i < pp.length; i++) {
				if (pp[i].id == current_id) {
					placemarks[i].options.set("preset", "twirl#workshopIcon");
					placemarks[i].options.set("draggable", true);
				}
				else {
					if (pp[i].id == pred_id) { 
						placemarks[i].options.set("preset", "twirl#shopIcon");
						placemarks[i].options.set("draggable", false);
					};
				};
			};
		};

	</script>
<%	end -%>
</head>
<body>
<% content_for :title do %>
Координаты торговых точек
<%	end -%>
<% content_for :content do %>
	<div id="wrapper">
		<div id="groupselect">
			<% form_tag do %>
				<fieldset>
					<legend>Настройки</legend>
					<nobr>
						<label for="subdealer">Выберите группу партнеров:</label>
						<%=  select(:post, :subdealer, @subdealers_list, {:selected => @subdealer}) %>
						
						<%= submit_tag 'Выбрать' %>
					</nobr>		
				</fieldset>
			<% end %> 
		</div>
		
		<div
			id="map"
			style="width: 60%;
			float: right;">
			<div id="YMapsID" ></div>
		</div>
		
		<div
			id="tableheader"
			style="width: 38%;
			float: left;">
			<div>
				<table width="100%" border="0" cellpadding="2" cellspacing="1">
				   <tr>
						<td width="20%" class="th1">Имя</td>
						<td width="80%">Адрес <br>Геокодированный адрес</td>
				   </tr>
				</table>
			</div>
		</div>
		
		<% form_tag( {:action => 'save_point'}, {:onsubmit => "if (isadr == 1 ) {isadr=0;return false;}"} ) do %>	
			<div id="buyers">	
				<div id="mainform">
						
						<table width="100%" border="0" cellpadding="2" cellspacing="1">
							<% @rst_buyers.each do |a| %>
							<tr
								<%= "id=\"row_#{a["id"]}\"" %> class="rdata" onclick="on_select(<%= a["id"] %>)" >
								<td width="20%" id="small_name" ><%= a["pname"] %></td>
								<td width="80%">
									<%= text_field(:a, :srcaddress, :index => a["id"] , :value => a["srcaddress"], :maxlength => 255, :class => "boxintbl", :style=>"background-color : transparent", :onkeypress => "submitIt(event, #{a["id"]});" ) %>
									<br/>
									<%= text_field(:a, :fulladdress, :index => a["id"] , :value => a["fulladdress"], :maxlength => 255, :class => "boxintable gray", :style=>"background-color : transparent", :readonly => 'true') %>
									<%= hidden_field(:a, :taddress, :index => a["id"] , :value => a["taddress"], :maxlength => 255) %>
								</td>
								<td style='display:none;' width="0%">
									<%= text_field(:a, :latitude, :size => 8, :index => a["id"] , :value => a["latitude"], :maxlength => 20, :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]}); $('a_#{a["id"]}_ismanual').checked = true;" ) %>
									<br/>
									<%= text_field(:a, :longitude, :size => 8, :index => a["id"] , :value => a["longitude"], :maxlength => 20, :style=>"background-color : transparent", :onkeydown => "on_needsave(#{a["id"]}); $('a_#{a["id"]}_ismanual').checked = true;" ) %>
								</td>
								<td style='display:none;' width="0%" align="center">
									<%= check_box(:a, :ismanual, :index => a["id"], :value => a["ismanual"], :style=>"border : none", :checked => (a["ismanual"]==1), :onclick => "on_needsave(#{a["id"]})" ) %> 
									<br/>
									<%= check_box(:a, :needsave, :index => a["id"], :style=>"border : none", :value => '0', :checked => false ) %>
								</td>			
							</tr>
							<% end %>				
						</table>			
						
				</div>
			</div>
			<div id="operblock">		
				<%= submit_tag "Сохранить" %>
			</div>
		<% end %>
		
	</div>
<% end -%>
<% render :file => 'layouts/application' %>