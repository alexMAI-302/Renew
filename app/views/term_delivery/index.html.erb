<% content_for :stylesheets do %>

	.center_content {
		margin: 0 0 0 300px;
		min-height: 500px;
		padding: 5px;
		position: relative;
	}

	TABLE.sort {
		width: 100%;
		cellpadding: 2px;
		cellspacing: 1px;
		border-collapse: collapse;
	}
	
	TABLE.sort TD {
		text-align: center;
		border-width: 1px;
		border-style: solid;
		border-color: lightGray;
	}
	
	TABLE.sort TH {
		background-color: lightGray;
		text-color: white;
		text-weight: semibold;
	}
	
	TABLE.scrollable_header TD {
		border-width: 1px;
		border-style: solid;
		border-color: white;
		text-align: center;
		border-collapse: collapse;
	}
		#routelist1
		{
			position:absolute; 
			top:120px;
			bottom:70%;
			left:30%;
			right:10px;
			border:1px dotted #000;
		}	
		#routes1
		{
			width: 100%;
			height: 78%;
			border-bottom: solid 1px #AAA;
			overflow: auto;
			float: left;			
		}		
		#operblock
		{
			float: left;
			left:10px; 
			padding: 10px 10px;
		}		
		#operblock2
		{
			left:10px; 
			top:100px; 
			padding: 10px 10px;
		}				
		#termlist1
		{
			position:absolute; 
			top:30%;
			bottom:10px;
			right:10px;
			left:10px;
			border:1px dotted #000;
		}
		#term1
		{
			width: 100%;
			height: 90%;
			border-bottom: solid 1px #AAA;
			overflow: auto;
			float: left;			
		}
		#term_header1 TR TD 
		{
			background-color: #AAA;
			font-weight: bold;
			color: #FFF;
		}
<% end %>

<% content_for :title do %>
	Инкассация терминалов
<% end %>

<% content_for :js do %>
	<%= javascript_include_tag :defaults %>
		<script>
									function start_update(tid){
									$('spinner_errortext_'+tid).show();
									$('term_errortext_'+tid).update('Подождите пожалуйста, идет расчет.....');
									};
			</script>
							
							
	<script type="text/javascript" charset="utf-8">
		var mode='base';
		var term=0;
		function on_super_select_zone(e)
		{
			<% @rst_route.each do	|a| %>
				$('zone_' + <%=  a["zone"] %>).style.backgroundColor = 'yellow';
				$$('tr.term_'+<%=  a["zone"] %>).each(function(d){
						d.style.display='';
				});
				
			<% end %>				
			
		};
		function on_route_click(sid){
			if ( mode == 'move' ) return;
			$$('input.zone_check_'+sid).each(function(d){
						if ($('r_'+sid+'_needsave').checked)
							d.value='1'
						else
							d.value='0'
			})		
		};
		
		function on_super_termsave_click(e){
			$$('input.termsave').each(function(d){
				if (d.parentNode.parentNode.style.display == '') {
					d.checked = $('super_termsave').checked;
				}
			});
		};
		
		function on_super_route_click(e){
			if ( mode == 'move' ) return;
			<% @rst_route.each do	|a| %>
				$('r_'+<%=  a["zone"] %>+'_needsave').checked = $('super_needsave').checked;
				on_route_click(<%=  a["zone"] %>);
			<% end %>
		};
		
		function on_route_check(sid,e){
			if ( mode == 'move' ) return;	
			if ($('r_'+sid+'_delivery').value<0) {
				$('r_'+sid+'_delivery_status4').checked = !$('r_'+sid+'_delivery_status4').checked;
				alert("По данному маршруту ещё не создана доставка");
			};
				
			if (!$('r_'+sid+'_delivery_status4').checked  && $('r_'+sid+'_delivery_status4_right').value == '0') {
				$('r_'+sid+'_delivery_status4').checked = true;
				alert("Нельзя снимать галку ИЗ с маршрута без прав на группу Снятие галки ИЗ в маршруте");
			}
			
			
		};
		
			
		function on_select_zone( sid,e ){
			if ( mode == 'move' ) return;
			if (e.shiftKey)
				if ($('zone_' + sid ).style.backgroundColor == 'yellow')
					$('zone_' + sid ).style.backgroundColor ='transparent'
				else
					$('zone_' + sid ).style.backgroundColor = 'yellow'
			else
			{
					
				
			$$('tr.zone').each(function(d){
					d.style.backgroundColor = 'transparent';
				});
				$('zone_' + sid ).style.backgroundColor = 'yellow';
			}
			
			<% @rst_route.each do	|a| %>
				if ($('zone_' + <%=  a["zone"] %>).style.backgroundColor == 'yellow')
				{
					$$('tr.term_'+<%=  a["zone"] %>).each(function(d){
						d.style.display='';
						})
				}
				else
				{
					$$('tr.term_'+<%=  a["zone"] %>).each(function(d){
						d.style.display='none';
						})
				}
			<% end %>	
		
		};
		function on_term_click(zone,row){
			var a = '';
			var b = '';
			if ( mode != 'move' ) 
			{
				if ($('a_'+row+'_termsave').checked)
					$('zone_'+zone).cells[3].textContent = $('zone_'+zone).cells[3].textContent -0 +1;
				else
					$('zone_'+zone).cells[3].textContent -= 1;		
				
				$('a_'+terminal+'_modified').value = 1;
			}
			else
			{
				$$('input.termsave').each(function(d){
						if (d.checked )
						{
							a=a+d.parentNode.parentNode.cells[3].textContent+', ';
							b=b+'<a><a><zone_old>'+d.parentNode.parentNode.cells[0].children[2].value+'</zone_old><zone>'+$('m_to_zone').value+'</zone><terminalid>'+d.parentNode.parentNode.cells[3].textContent+'</terminalid></a></a>';
						}
					})	
				$('term_to_move_v').value=a;
				$('m_term_to_move').value='<hash>'+b+'</hash>';
			}
			
		};
		function switch_mode(value,e){
			if ( mode == 'move' ) 
				return;
			if (value != -666) 
			{
				$('term_commit').style.display='none';
				$('iz_commit').style.display='none';
				$('move_commit').style.display='';
				$('move_clear').style.display='';
				on_super_select_zone(e);
			}
			$$('input.termsave').each(function(d){
						if (d.checked )
							d.checked = false;
									})	
			
			mode = 'move';
		};
		function on_move_clear(e){
			if ( mode == 'move' ) 
			{
				$('term_to_move_v').value;
				$$('input.termsave').each(function(d){ if (d.checked ) d.checked = false; });			
			}
			
		};
		
		function on_term_info_click(sid,e){
			var info
			info = $('term_'+sid).cells[12].textContent
			$('term_'+sid).cells[12].innerHTML='<input id="a_'+sid+'_info" name="a['+sid+'][info]" type="text" value="'+info+'">';
			
		};
		function on_terminal_break_change(e)
		{
			if (term !=0)
			{
				$('a_'+term+'_terminal_break').value =	$('c_terminal_break').value;			
				var objSel = document.getElementById('c_terminal_break');
				for (var i=0; i < objSel.options.length; i++)
				{
					if (objSel.options[i].selected)
					{
						$('term_'+term).cells[14].textContent = objSel.options[i].text;
						break;
					}
				}
				$('a_'+term+'_modified').value = 1;
				
			}
		};
		function on_techinfo_change(e)
		{
			if (term !=0)
			{
				<% if !(@spv_id==5626) and !(@save_osh==0) -%>
					$('a_'+term+'_techinfo').value =	$('techinfo').value;					
					$('term_'+term).cells[15].textContent =  $('techinfo').value
					$('a_'+term+'_penaltystatus').value = $('c_penaltystatus').value;
					$('a_'+term+'_penaltystatus').checked = $('c_penaltystatus').checked;
				
				<% end -%>
				$('a_'+term+'_terminal_break').value = $('c_terminal_break').value
				$('term_'+term).cells[11].textContent =  $('c_terminal_break').options[$('c_terminal_break').selectedIndex].label;
				<% if !(@spv_id==5626) -%>
					$('a_'+term+'_servstatus').value = $('c_servstatus').value;
					$('a_'+term+'_servstatus').checked = $('c_servstatus').checked;
				<% end -%>
				$('a_'+term+'_modified').value = 1;
			}
		};
		function on_select_terminal(row,e)
		{
			var objSel = document.getElementById('c_terminal_break');
			var len = objSel.options.length;
			if (term) 
			{
				$('term_'+term).style.borderStyle = '';
			}
			$('term_'+row).style.borderStyle = 'solid';
			term = row
			
			if (!$('a_'+row+'_terminal_break').value)
				objSel.options[objSel.options.length - 1].selected = true;
				else
					for (var i=0; i < objSel.options.length; i++)
					{
						objSel.options[i].selected = false;
						if (objSel.options[i].value == $('a_'+row+'_terminal_break').value)
						{
							objSel.options[i].selected = true;
							break;
						}
					}
				
				$('c_terminal_break').value = $('a_'+row+'_terminal_break').value;
				
			<% if !(@spv_id==5626) and !(@save_osh==0) -%>
				$('techinfo').value = $('a_'+row+'_techinfo').value;
				$('c_penaltystatus').value = $('a_'+row+'_penaltystatus').value ;
				$('c_penaltystatus').checked = $('a_'+row+'_penaltystatus').checked ;
			<% end -%>

			<% if !(@spv_id==5626) -%>
				$('c_servstatus').value = $('a_'+row+'_servstatus').value ;
				$('c_servstatus').checked = $('a_'+row+'_servstatus').checked ;
			<% end -%>
			
		};
	</script>
	<script>
		function start_proc(tid){
			$('spinner'+tid).show();
			$('row_'+tid).update('Подождите пожалуйста, идет расчет.....');
		};
	</script>
	
	<script type="text/javascript">
	<!--
	/*
	originally written by paul sowden <paulidontsmoke.co.uk> | http://idontsmoke.co.uk
	modified and localized by alexander shurkayev <alshur@ya.ru> | http://htmlcssjs.ru
	*/
	
	var img_dir = "/images/sort_"; // папка с картинками
	var sort_case_sensitive = false; // вид сортировки (регистрозависимый или нет)
	
	// ф-ция, определяющая алгоритм сортировки
	function _sort(a, b) {
		var a = a[0];
		var b = b[0];
		var _a = (a + '').replace(/,/, '.');
		var _b = (b + '').replace(/,/, '.');
		if (a.indexOf("/")>0  )
		{
			var da = a.substr(3,3)+a.substr(0,2)+a.substr(5);
			var db = b.substr(3,3)+b.substr(0,2)+b.substr(5);
			if (Date.parse(da) && Date.parse(db)) return sort_numbers( Date.parse(db), Date.parse(da));
		}
		if (parseFloat(_a) && parseFloat(_b)) return sort_numbers(parseFloat(_a), parseFloat(_b));
		else if (!sort_case_sensitive) return sort_insensitive(a, b);
		else return sort_sensitive(a, b);
	}

	// ф-ция сортировки чисел
	function sort_numbers(a, b) {
		return a - b;
	}

	// ф-ция регистронезависимой сортировки
	function sort_insensitive(a, b) {
		var anew = a.toLowerCase();
		var bnew = b.toLowerCase();
		if (anew < bnew) return -1;
		if (anew > bnew) return 1;
		return 0;
	}

	// ф-ция регистрозависимой сортировки
	function sort_sensitive(a, b) {
		if (a < b) return -1;
		if (a > b) return 1;
		return 0;
	}

	// вспомогательная ф-ция, выдирающая из дочерних узлов весь текст
	function getConcatenedTextContent(node) {
		var _result = "";
		if (node == null) {
        return _result;
		}
		var childrens = node.childNodes;
		var i = 0;
		while (i < childrens.length) {
			var child = childrens.item(i);
			switch (child.nodeType) {
				case 1: // ELEMENT_NODE
				case 5: // ENTITY_REFERENCE_NODE
					_result += getConcatenedTextContent(child);
					break;
				case 3: // TEXT_NODE
				case 2: // ATTRIBUTE_NODE
				case 4: // CDATA_SECTION_NODE
					_result += child.nodeValue;
					break;
				case 6: // ENTITY_NODE
				case 7: // PROCESSING_INSTRUCTION_NODE
				case 8: // COMMENT_NODE
				case 9: // DOCUMENT_NODE
				case 10: // DOCUMENT_TYPE_NODE
				case 11: // DOCUMENT_FRAGMENT_NODE
				case 12: // NOTATION_NODE
				// skip
            break;
        }
        i++;
    }
    return _result;
}

// суть скрипта
function sort(e) {
    var el = window.event ? window.event.srcElement : e.currentTarget;
    while (el.tagName.toLowerCase() != "td") el = el.parentNode;
    var a = new Array();
    var name = el.lastChild.nodeValue;
    var dad = el.parentNode;
    var table = dad.parentNode.parentNode;
    var up = table.up;
    var node, arrow, curcol;
    for (var i = 0; (node = dad.getElementsByTagName("td").item(i)); i++) {
		if (node.style.display == 'none') {continue}
        if (node.lastChild.nodeValue == name){
            curcol = i;
            if (node.className == "curcol"){
                arrow = node.firstChild;
                table.up = Number(!up);
            }else{
                node.className = "curcol";
                arrow = node.insertBefore(document.createElement("img"),node.firstChild);
                table.up = 0;
            }
            arrow.src = img_dir + table.up + ".gif";
            arrow.alt = "";
        }else{
            if (node.className == "curcol"){
                node.className = "";
                if (node.firstChild) node.removeChild(node.firstChild);
            }
        }
	}
    var tbody = table.getElementsByTagName("tbody").item(0);
    for (var i = 0; (node = tbody.getElementsByTagName("tr").item(i)); i++) {
		if (node.style.display == 'none') {continue};
        a[i] = new Array();
        a[i][0] = getConcatenedTextContent(node.getElementsByTagName("td").item(curcol));
        a[i][1] = getConcatenedTextContent(node.getElementsByTagName("td").item(1));
        a[i][2] = getConcatenedTextContent(node.getElementsByTagName("td").item(0));
        a[i][3] = node;
    }
    a.sort(_sort);
    if (table.up) a.reverse();
    for (var i = 0; i < a.length; i++) {
		if (a[i])
		{
			//if node = tbody.getElementsByTagName("tr").item(i);
			//if (node.style.display == 'none') {continue}
			tbody.appendChild(a[i][3]);
		}
    }
}

// ф-ция инициализации всего процесса
function init(e) {
    if (!document.getElementsByTagName) return;

    for (var j = 0; (thead = document.getElementsByTagName("thead").item(j)); j++) {
        var node;
		// было var i = 0, но мне не нужна сортировка по первому полю
        for (var i = 1; (node = thead.getElementsByTagName("td").item(i)); i++) {
            if (node.addEventListener) node.addEventListener("click", sort, false);
            else if (node.attachEvent) node.attachEvent("onclick", sort);
            node.title = "Нажмите на заголовок, чтобы отсортировать колонку";
        }
        thead.parentNode.up = 0;
        
        if (typeof(initial_sort_id) != "undefined"){
            td_for_event = thead.getElementsByTagName("td").item(initial_sort_id);
            if (document.createEvent){
                var evt = document.createEvent("MouseEvents");
                evt.initMouseEvent("click", false, false, window, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, td_for_event);
                td_for_event.dispatchEvent(evt);
            } else if (td_for_event.fireEvent) td_for_event.fireEvent("onclick");
            if (typeof(initial_sort_up) != "undefined" && initial_sort_up){
                if (td_for_event.dispatchEvent) td_for_event.dispatchEvent(evt);
                else if (td_for_event.fireEvent) td_for_event.fireEvent("onclick");
            }
        }
    }
}

// запускаем ф-цию init() при возникновении события load
var root = window.addEventListener || window.attachEvent ? window : document.addEventListener ? document : null;
if (root){
    if (root.addEventListener) root.addEventListener("load", init, false);
    else if (root.attachEvent) root.attachEvent("onload", init);
}
//-->
</script>

	
<% end %>

<% content_for :left_content do %>

	<div id="operblock" style="background-color: white">
		<% form_tag do %>
				<%=  select(:post, :subdealer, @subdealers_list, {:selected => @subdealer}) %>
				<br/>	
				<%=  select(:post, :spv_id, @zone_type_list, {:selected => @spv_id}) %>
				<br/>	
				<label for="ddate">Дата</label>
				<%=text_field_tag :ddate, @ddate %> 
				<br/>
				<label for="ddate">Только c ошибками</label>
				<%= check_box(:post, :err_only, :class => "err_only", :value => @err_only, :checked => @err_only==0 ? false : true) %>
				<br/>
				
				<label for="ddate">Только в маршруте </label>
				<%= check_box(:post, :show_inroute, :class => "show_inroute", :value => @show_inroute, :checked => @show_inroute==0 ? false : true) %>
				<br/>
				<input name="commit" type="submit" value="Обновить терминалы" />
				<br/>	
				<%= link_to " Зоны терминалов ",  :action => 'zone' %>
		<% end %>
		 <% if flash[:notice] -%>     
		      <%= flash[:notice] %></div>  
		    <% end -%>


	</div>
	
	<% form_tag :action => 'status4_save' do %>	
		<DIV id="routelist" style="float: left;">
			Список маршрутов
			<nobr>
			</nobr>
			<div id="routelist_header" style='padding-right: 1px;'>
				<table class="scrollable_header" style="background-color: silver">
					<tr>
						<td width="9%" rowspan="2">&nbsp<%= check_box(:super, :needsave, :value => '0', :checked => false, :onclick => "on_super_route_click()") %></td>
						<td width="42%" onclick="on_super_select_zone(event)" rowspan="2">Имя</td>
						<td width="43%" colspan="2">Терминалов</td>
						<td width="7%" rowspan="2">П</td>
						<td width="7%" rowspan="2">ИЗ</td>
						<td width="7%" rowspan="2">Э</td>
					</tr>
					<tr>
						<td width="14%">Всего</td>
						<td width="86%">В маршруте</td>
					</tr>
				</table>
			</div>
			<div id="routes" style="overflow: auto; height: 400px; border-bottom: 1px solid gray">
				<table class="sort2" id="routes_body">
				<tbody>
					<% @rst_route.each do |r| %>
						<tr <%= "id=\"zone_#{r["zone"]}\"" %> class="zone">
							<td width="9%" ><%= check_box(:r, :needsave, :index => r["zone"], :value => '0', :checked => r["points_inroute"]==0 ? false : true, :onclick => "on_route_click(#{r["zone"]})", :readonly => 'true') %></td>
							<td width="36%" onclick="on_select_zone(<%= r["zone"] %>,event)"><%=  r["zone_name"] %></td>
							<td width="9%" onclick="on_select_zone(<%= r["zone"] %>,event)" ><%=  r["points"] %></td>
							<td width="28%" onclick="on_select_zone(<%= r["zone"] %>,event)" id="routes_body_{}"><%= r["points_inroute"] %></td>
							<td width="9%" ><%= link_to(image_tag("/images/printer.png", :size=>"16x14"),{  :action => 'route_print', :zone =>r["zone"], :date=>@ddate, :rel=>"external"}) %></td>
							<td width="9%" >
								<% if !(r["zone"]==666) then %>
									<%= check_box(:r, :delivery_status4, :index => r["zone"], :value => 0, :checked => r["delivery_status4"]==0 ? false : true, :onclick => "on_route_check(#{r["zone"]},event)", :readonly => r["delivery"]>0 ? false : true) %>
								<% end %>
							</td>
							<td width="9%" >
								<% if !(r["zone"]==666) then %>
									<%= link_to(image_tag("/images/excel.jpg", :size=>"16x16"),{  :action => 'route_export', :zone =>r["zone"], :date=>@ddate, :rel=>"external"}) %>
								<% end %>
							</td>
							
							
							<%= hidden_field(:r, :delivery_status4_right, :index => r["zone"], :value => r["delivery_status4_right"] ) %>
							<%= hidden_field(:r, :delivery, :index => r["zone"], :value => r["delivery"] ) %>
						</tr>
					<% end %>				
				</tbody>
				</table>
			</div>
		<br/>
		<% if !(@save_IS==0) then %>
			<input id="iz_commit" name="commit" type="submit" value="Сохранить ИЗ" />
		<% end %>
		</DIV>		
	<% end %>
<% end %>

<% content_for :content do %>
	<% if !(@submit==0) then %>
	<DIV>
		<% form_tag :action => 'move_terminal' do %>
			<fieldset>
				<legend>Перемещение терминалов</legend>
				<label for="to_zone">Переместить </label>
				<%=text_field_tag :term_to_move_v, :term_to_move_v, :size => "70", :value=>"", :readonly=>'true'%> 
				<%= hidden_field(:m, :term_to_move, :value => "" ) %>
				<label for="to_zone">в зону </label>
				<%=  select(:m, :to_zone, @zone_list, {:selected => -666}, :onchange => "switch_mode(this.value,event)"  ) %>
				<input id="move_commit" name="commit" type="submit" value="Переместить" style="display : none"/>
				<input id="move_clear" name="move_clear" type="button" value="Очистить" onclick="on_move_clear(event)"  style="display : none">
			</fieldset>
		<% end %>
	</DIV>
	<% end %>
			
	<% form_tag :action => 'save_terminal' do %>	
		<DIV id="operblock2">
			<nobr>
					<% if !(@submit==0) then %><input id="term_commit" name="commit" type="submit" value="Сформировать доставки" />
					<fieldset>
						<legend>Комментарий</legend>
						<label for="terminal_break">Вид поломки</label>
						<%=select(:c, :terminal_break, @break_list, {:selected => -666}, :onchange => "on_techinfo_change(event)" ) %>
						<% if !(@spv_id==5626) -%>
							<label for="servstatus">C</label>
							<%= check_box(:c, :servstatus, :value => 0, :checked => false, :onchange => "on_techinfo_change(event)") %>
							<% if !(@spv_id==5626) and !(@save_osh==0) -%>
								<label for="penaltystatus">ОШ</label>
								<%= check_box(:c, :penaltystatus, :value => 0, :checked => false, :onchange => "on_techinfo_change(event)") %>
								<label for="teсhinfo">Причина</label>
								<%=text_field_tag :techinfo, :techinfo, :size => "50", :value=>"", :onchange => "on_techinfo_change(event)" %> 			
							<% end -%>
						<% end -%>	
					</fieldset>
					<% end %>
					
			</nobr>
		</DIV>
		<DIV id="termlist" style="width: 1400px; overflow: auto; border-bottom: 1px solid gray;">
			Список терминалов
			
			<div id="term_header" style='padding-right: 16px;'>
				<table class="sort" style="overflow: auto; height: 500px;">
				<thead style="background-color: silver">
					<tr>
						<td width="2%">&nbsp<%= check_box(:super, :termsave, :value => '0', :checked => false, :onclick => "on_super_termsave_click()") %></td>
						<td width="3%">п/п</td>
						<td width="8%">Зона</td>
						<td width="4%">Term. Id</td>
						<td width="17%">Имя терминала</td>
						<% if (@spv_id==5626) -%><td width="6%">Кол-во денег в терминале</td> <% end -%>
						<% if (@spv_id==5626) -%><td width="6%">Кол-во купюр в терминале</td> <% end -%>
						<td width="4%">Последний сигнал</td>
						<td width="4%">Последний платёж</td>
						<% if (@spv_id==6626) -%><td width="6%">Кол-во денег в терминале</td> <% end -%>
						<% if (@spv_id==6626) -%><td width="6%">Кол-во купюр в терминале</td> <% end -%>
						<td width="4%">Уровень сигнала</td>		
						<td width="10%">Состояние</td>		
						<td width="8%">Причина включения в маршрут</td>		
						<td width="4%">Система</td>
						<% if (@spv_id==5626) -%><td width="8%">Субагент</td>	<% end -%>					
						<td width="5%">Вид поломки</td>						
						<td width="7%">Отделение банка</td>
						<% if !(@spv_id==5626) -%><td width="2%">С</td>	<% end -%>				
						<% if !(@spv_id==5626) and !(@save_osh==0) -%><td width="2%">ОШ</td>	<% end -%>				
						<% if !(@spv_id==5626) and !(@save_osh==0) -%><td width="16%">Комментарий ОШ</td>	<% end -%>				
						<td width="4%">&nbsp</td>
					</tr>
				</thead>
				<tbody>
					<% @rst_term.each_with_index do |a, i| %>
						<tr <%= "id=\"term_#{a["row"]}\"" %> class="term_<%=a["zone"]%>"  style="display:none; <% if not a["style"].nil? -%><%= a["style"]%><% end -%>" onclick="on_select_terminal(<%= a["row"] %>,event)" >
						<td width="2%"><%= check_box(:a, :termsave, :index => a["row"], :class => "termsave", :value => '0', :checked => a["inroute"]==0 ? false : true, :onclick => "on_term_click(#{a["zone"]},#{a["row"]})") %>
								<%= hidden_field(:a, :terminalid, :index => a["row"], :value => a["terminalid"] ) %>
								<%= hidden_field(:a, :zone, :index => a["row"], :value => a["zone"] ) %>
								<%= hidden_field(:a, :zone_check, :class => "zone_check_#{a["zone"]}", :index => a["row"], :value => 1 ) %>
								<%= hidden_field(:a, :modified, :index => a["row"], :value => a["modified"] ) %>		
								<%= hidden_field(:a, :terminal_break, :index => a["row"], :value => a["terminal_break"] ) %>								
								<%= hidden_field(:a, :techinfo, :index => a["row"], :value => a["techinfo"] ) %>								
							</td>
							
							<td width="3%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%=  i+1 %></td>							
							<td width="8%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["zone_name"]%></td>
							<td width="4%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%=  a["real_terminalid"] %></td>
							<td width="17%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%=  a["name"] %></td>
							<% if (@spv_id==5626) -%><td width="6%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%=  a["summ"] %></td> <% end -%>
							<% if (@spv_id==5626) -%><td width="6%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["cnt"] %></td> <% end -%>
							<td width="4%" <% if not a["LastConnectTime_style"].nil? -%>style="<%= a["LastConnectTime_style"]%>" <% end -%> >
								<%= image_tag('ajax-loader.gif', :id => 'spinner_lastconnecttime_'+a["terminalid"].to_s, :style => 'display:none') %>
								<div id="term_lastconnecttime_<%=a["terminalid"]%>">
									<%= a["LastConnectTime"].nil? ? '' : a["LastConnectTime"].to_time.strftime("%d/%m/%Y %H:%M") %>
								</div>
							</td>
							<td width="4%" <% if not a["LastPaymentTime_style"].nil? -%>style="<%= a["LastPaymentTime_style"]%>" <% end -%> >
								<%= image_tag('ajax-loader.gif', :id => 'spinner_lastpaymenttime_'+a["terminalid"].to_s, :style => 'display:none') %>
								<div id="term_lastpaymenttime_<%=a["terminalid"]%>">
									<%= a["LastPaymentTime"].nil? ? '' : a["LastPaymentTime"].to_time.strftime("%d/%m/%Y %H:%M") %>
								</div>
							</td>	
							<% if (@spv_id==6626) -%><td width="6%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%=  a["summ"] %></td> <% end -%>
							<% if (@spv_id==6626) -%><td width="6%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["cnt"] %></td> <% end -%>
							<td width="4%" ALIGN="right" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%= a["SignalLevel"] %></td>
							<td width="10%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> >
								<%= image_tag('ajax-loader.gif', :id => 'spinner_errortext_'+a["terminalid"].to_s, :style => 'display:none') %>
								<div id="term_errortext_<%=a["terminalid"]%>">
									<%= h(a["ErrorText"]) %>
								</div>
							</td>
							<td width="8%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%>><%= a["IncassReason"] %></td>
							<td width="4%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["src_system_name"]%></td>
							<% if (@spv_id==5626) -%><td width="8%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["subdealer_name"] %></td>	<% end -%>						
							<td width="5%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["terminal_break_name"] %></td>							
							<td width="7%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["branch_name"]%></td>		
							<% if !(@spv_id==5626) -%>
								<td width="2%">
									<%= image_tag('ajax-loader.gif', :id => 'spinner_servstatus_'+a["terminalid"].to_s, :style => 'display:none') %>
									<div id="term_errortext_<%=a["terminalid"]%>">
										<%= check_box(:a, :servstatus, :index => a["row"], :class => "servstatus", :value => '0', :checked => a["servstatus"]==0 ? false : true) %>
									</div>
								</td>
							<% end -%>	
							<% if !(@spv_id==5626) and !(@save_osh==0) -%><td width="2%"><%= check_box(:a, :penaltystatus, :index => a["row"], :class => "penaltystatus", :value => '0', :checked => a["penaltystatus"]==0 ? false : true) %> <% end -%>	
							<% if !(@spv_id==5626) and !(@save_osh==0)  -%><td width="16%" <% if not a["style"].nil? -%>style="<%= a["style"]%>" <% end -%> ><%=  a["techinfo"] %></td>	<% end -%>		
							<td width="4%"><%= link_to_function 'Обновить', remote_function(:update =>"term_errortext_"+a["terminalid"].to_s, :before => "$('spinner_errortext_"+a["terminalid"].to_s+"').show();", :complete => "$('spinner_errortext_"+a["terminalid"].to_s+"').hide();"+
								remote_function(:update =>"term_servstatus_"+a["terminalid"].to_s, :before => "$('spinner_servstatus_"+a["terminalid"].to_s+"').show();", :complete => "$('spinner_servstatus_"+a["terminalid"].to_s+"').hide();",:url => { :action => "term_update_servstatus"}, :with => "'terminalid="+a["terminalid"].to_s+"'" )+";"+
								remote_function(:update =>"term_lastconnecttime_"+a["terminalid"].to_s, :before => "$('spinner_lastconnecttime_"+a["terminalid"].to_s+"').show();", :complete => "$('spinner_lastconnecttime_"+a["terminalid"].to_s+"').hide();",:url => { :action => "term_update_lastconnecttime"}, :with => "'terminalid="+a["terminalid"].to_s+"'" )+";"+								
								remote_function(:update =>"term_lastpaymenttime_"+a["terminalid"].to_s, :before => "$('spinner_lastpaymenttime_"+a["terminalid"].to_s+"').show();", :complete => "$('spinner_lastpaymenttime_"+a["terminalid"].to_s+"').hide();",:url => { :action => "term_update_lastpaymenttime"}, :with => "'terminalid="+a["terminalid"].to_s+"'" )+";" ,  :url => { :action => "term_update"}, :with => "'terminalid="+a["terminalid"].to_s+"'")  %></td>
							</tr>
						<% end %>				
				</tbody>
				</table>
			</div>	
		</div>
	<% end %>
<% end %>